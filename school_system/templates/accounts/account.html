{% extends "base.html" %}
{% load static %}
{% load account_extras %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard/profile.css' %}">
<link rel="stylesheet" href="{% static 'css/accounts/account.css' %}">
{% endblock %}

{% block title %}Account{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col">
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    {% if user.profile.profile_picture %}
                        <img src="{{ user.profile.profile_picture.url }}" alt="avatar" class="profile-img mb-3">
                    {% else %}
                        <p>No profile picture</p>
                    {% endif %}
                    <h5 class="mt-2">{{ user.first_name }} {{ user.last_name }}</h5>
                    <p class="text-muted">{{ user.email }}</p>
                    <p class="badge bg-primary text-uppercase">{{ user.get_role_display }}</p>
                    {% if user.profile.date_of_birth %}
                        <p class="text-muted">Date of Birth: {{ user.profile.date_of_birth|date:"d M Y" }}</p>
                    {% else %}
                        <p class="text-muted">Date of Birth: Not set</p>
                    {% endif %}
                </div>
            </div>

            {% include "accounts/navbar.html" %}
        </div>


    </div>
</div>

{% endblock %}


{% block extrascripts %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<meta name="csrf-token" content="{{ csrf_token }}">

<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    axios.defaults.headers.common['X-CSRFToken'] = csrfToken;

    function showModal(id) {
        const modal = new bootstrap.Modal(document.getElementById(id));
        modal.show();
    }

    function submitAjaxForm(formId, containerId, modalId = null) {
        const form = document.getElementById(formId);
        if (!(form instanceof HTMLFormElement)) {
            console.error("Invalid form element for", formId);
            return;
        }

        const formData = new FormData(form);
        axios.post(form.action, formData)
            .then(response => {
                console.log(response);
                document.getElementById(containerId).innerHTML = response.data.html;
                if (modalId) {
                    const modalEl = document.getElementById(modalId);
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                }
                form.reset();
            })
            .catch(error => {
                console.error("AJAX form submission failed:", error);
            });
    }

    window.showModal = showModal;
    window.submitAjaxForm = submitAjaxForm;

    window.removeChild = function (childId) {
        if (!confirm("Are you sure you want to remove this child?")) return;
        axios.post("/ajax/remove-child/", { child_id: childId })
            .then(response => {
                document.getElementById("children-container").innerHTML = response.data.html;
            })
            .catch(error => {
                console.error("Remove child failed:", error);
            });
    };

    window.removeSubject = function (subjectId) {
        if (!confirm("Are you sure you want to remove this subject?")) return;
        axios.post("/ajax/remove-subject/", { subject_id: subjectId })
            .then(response => {
                document.getElementById("subjects-container").innerHTML = response.data.html;
            })
            .catch(error => {
                console.error("Remove subject failed:", error);
            });
    };
});
</script>
{% endblock %}
